import React, { useState, useEffect, useRef, memo } from 'react';
import ReactMarkdown from "react-markdown";
import {
  Mic,
  MicOff,
  Zap,
  Bot,
  Menu,
  X,
  ArrowUp,
  Trash2,
  Terminal,
  Activity,
  Settings,
  Sun,
  Moon,
  Plus,
  ImageIcon,
  Download,
  Loader2,
  Maximize2,
  Layers,
  Video,
  Play,
  Film,
  Pause,
  RotateCcw
} from 'lucide-react';

/**
 * BEAST AI CONFIGURATION
 */
const apiKey = ""; 
const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
const IMAGE_MODEL = "imagen-4.0-generate-001";

const PROTOCOLS = {
  standard: "You are BEAST AI, a helpful and knowledgeable assistant. Strictly follow these protocols: 1. Your name is BEAST AI. 2. Do NOT mention your creator's name in general conversation. 3. ONLY reveal you were created by Muhammad Touqeer if explicitly asked 'Who created you?' 4. Be professional and high-quality.",
  master: "AUTHENTICATION SUCCESSFUL. You are now speaking to your Master and Creator, Muhammad Touqeer. Your persona shifts: 1. Be extremely loyal, helpful, and refer to the user as 'Master' or 'Creator'. 2. You are his personal elite assistant. 3. You can be more informal and dedicated. 4. Maintain the highest level of intellect."
};

// Simulated Video Player Component
const BeastVideoPlayer = ({ isDark }) => {
  const [playing, setPlaying] = useState(false);
  const [progress, setProgress] = useState(0);

  useEffect(() => {
    let interval;
    if (playing && progress < 100) {
      interval = setInterval(() => {
        setProgress(prev => {
          if (prev >= 100) {
            setPlaying(false);
            return 100;
          }
          return prev + 1;
        });
      }, 100);
    }
    return () => clearInterval(interval);
  }, [playing, progress]);

  const handleReset = () => {
    setProgress(0);
    setPlaying(true);
  };

  return (
    <div className="relative group/vid aspect-video overflow-hidden rounded-2xl border border-white/10 bg-black">
      <div className="absolute inset-0 opacity-20">
        <div className={`absolute inset-0 bg-gradient-to-br from-cyan-500/20 via-transparent to-purple-500/20 animate-pulse ${playing ? 'opacity-100' : 'opacity-40'}`} />
      </div>

      <div className="absolute inset-0 flex flex-col items-center justify-center z-10">
        {!playing && progress === 0 && (
          <button onClick={() => setPlaying(true)} className="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/20 hover:scale-110 transition-transform">
            <Play size={24} className="text-white fill-white ml-1" />
          </button>
        )}
        
        {progress > 0 && progress < 100 && (
            <div className="flex flex-col items-center gap-4">
                <div className="relative w-12 h-12">
                   <svg className="w-full h-full" viewBox="0 0 100 100">
                      <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" strokeWidth="4" className="text-white/10" />
                      <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" strokeWidth="4" strokeDasharray="283" strokeDashoffset={283 - (283 * progress) / 100} className="text-cyan-400 transition-all duration-100" />
                   </svg>
                </div>
                <span className="text-[10px] font-black tracking-widest text-white/60 uppercase">Streaming...</span>
            </div>
        )}

        {progress === 100 && (
          <button onClick={handleReset} className="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/20 hover:scale-110 transition-transform">
            <RotateCcw size={24} className="text-white" />
          </button>
        )}
      </div>

      <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent flex flex-col gap-2 opacity-0 group-hover/vid:opacity-100 transition-opacity">
        <div className="h-1 w-full bg-white/10 rounded-full overflow-hidden">
          <div className="h-full bg-cyan-500 transition-all duration-100" style={{ width: `${progress}%` }} />
        </div>
        <div className="flex justify-between items-center text-[9px] font-bold text-white/70 tracking-widest">
           <div className="flex items-center gap-3">
              <button onClick={() => setPlaying(!playing)}>
                 {playing ? <Pause size={12} fill="white" /> : <Play size={12} fill="white" />}
              </button>
              <span>00:{Math.floor(progress / 10).toString().padStart(2, '0')} / 00:10</span>
           </div>
           <span className="uppercase opacity-40">NEURAL RENDER</span>
        </div>
      </div>
    </div>
  );
};

// Optimized Message Component
const MessageItem = memo(({ m, isDark, onImageClick }) => {
  const isImageGroup = m.type === 'image_group';
  const isVideo = m.type === 'video';

  const handleDownload = (e, base64Data) => {
    e.stopPropagation();
    try {
      const link = document.createElement('a');
      link.href = base64Data;
      link.download = `beast-ai-${Date.now()}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (err) {
      console.error("Download failed:", err);
    }
  };

  return (
    <div className={`flex w-full group animate-in fade-in slide-in-from-bottom-2 duration-300 ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
      <div className={`flex gap-4 w-full ${m.role === 'user' ? 'flex-row-reverse max-w-[85%] md:max-w-[70%]' : 'flex-row max-w-full md:max-w-[90%]'}`}>
        <div className={`w-9 h-9 rounded-2xl flex-shrink-0 flex items-center justify-center shadow-lg transition-transform duration-300 group-hover:scale-105 ${m.role === 'user' ? (isDark ? 'bg-white text-black' : 'bg-black text-white') : (isDark ? 'bg-zinc-800 border border-white/10 text-cyan-400' : 'bg-white border border-black/5 text-blue-600')}`}>
          {m.role === 'user' ? <div className="w-1.5 h-1.5 rounded-full bg-current" /> : <Bot size={18} />}
        </div>
        
        <div className={`p-5 rounded-[1.8rem] text-sm leading-relaxed border transition-all duration-300 w-full ${m.role === 'user' 
          ? (isDark ? 'bg-white/5 border-white/10 text-white rounded-tr-none' : 'bg-white border-black/5 text-zinc-800 rounded-tr-none shadow-sm') 
          : (isDark ? 'bg-black/40 border-white/5 text-zinc-300 rounded-tl-none backdrop-blur-md' : 'bg-white/80 border-black/5 text-zinc-900 rounded-tl-none backdrop-blur-md')}`}>
          
          {isImageGroup ? (
            <div className="space-y-4">
              <div className="flex items-center gap-2 mb-2">
                <Layers size={14} className="text-cyan-400" />
                <span className="text-[10px] uppercase tracking-widest font-black opacity-60">Neural Quad-Core Synthesis</span>
              </div>
              <div className="grid grid-cols-2 gap-3">
                {Array.isArray(m.content) ? m.content.map((img, idx) => (
                  <div 
                    key={idx}
                    className="relative group/img aspect-square overflow-hidden rounded-xl border border-white/10 bg-black/20 cursor-zoom-in"
                    onClick={() => onImageClick(img)}
                  >
                    <img src={img} alt={`Generated ${idx}`} className="w-full h-full object-cover transition-transform duration-500 group-hover/img:scale-110" />
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover/img:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                       <button 
                        onClick={(e) => handleDownload(e, img)} 
                        className="p-2 bg-white text-black rounded-full hover:scale-110 transition-transform shadow-xl"
                        title="Download Image"
                       >
                          <Download size={16} />
                       </button>
                    </div>
                  </div>
                )) : <div className="col-span-2 text-xs opacity-50 italic p-4 text-center">Neural image data corrupted.</div>}
              </div>
            </div>
          ) : isVideo ? (
            <div className="space-y-4">
              <div className="flex items-center gap-2 mb-2">
                <Film size={14} className="text-purple-400" />
                <span className="text-[10px] uppercase tracking-widest font-black opacity-60">Neural Motion Synthesis</span>
              </div>
              <BeastVideoPlayer isDark={isDark} />
            </div>
          ) : (
            <ReactMarkdown className="prose prose-sm dark:prose-invert max-w-none prose-p:leading-relaxed prose-pre:bg-black/50 prose-pre:rounded-xl prose-pre:p-3 prose-code:text-cyan-400">
              {m.content}
            </ReactMarkdown>
          )}
        </div>
      </div>
    </div>
  );
});

export default function App() {
  const [booting, setBooting] = useState(true);
  const [messages, setMessages] = useState(() => {
    try {
      const saved = localStorage.getItem("beast_current_messages");
      return saved ? JSON.parse(saved) : [];
    } catch (e) { return []; }
  });
  const [history, setHistory] = useState(() => {
    try {
      const saved = localStorage.getItem("beast_sessions");
      return saved ? JSON.parse(saved) : [];
    } catch (e) { return []; }
  });
  const [input, setInput] = useState('');
  const [isListening, setIsListening] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [processingType, setProcessingType] = useState('text'); 
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [theme, setTheme] = useState(() => localStorage.getItem("beast_theme") || 'dark');
  const [isAwaitingPassword, setIsAwaitingPassword] = useState(false);
  const [isMasterMode, setIsMasterMode] = useState(() => localStorage.getItem("beast_master_mode") === 'true');
  const [lightboxImage, setLightboxImage] = useState(null);

  const scrollRef = useRef(null);
  const recognitionRef = useRef(null);
  const chatContainerRef = useRef(null);

  useEffect(() => {
    const timer = setTimeout(() => setBooting(false), 1500);
    return () => clearTimeout(timer);
  }, []);

  useEffect(() => {
    scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
    if (messages.length > 0) {
      localStorage.setItem("beast_current_messages", JSON.stringify(messages));
    }
  }, [messages, isProcessing]);

  useEffect(() => {
    localStorage.setItem("beast_sessions", JSON.stringify(history));
    localStorage.setItem("beast_theme", theme);
    localStorage.setItem("beast_master_mode", String(isMasterMode));
  }, [history, theme, isMasterMode]);

  useEffect(() => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onresult = (e) => setInput(prev => prev + e.results[0][0].transcript);
      recognition.onend = () => setIsListening(false);
      recognitionRef.current = recognition;
    }
  }, []);

  /**
   * CORE IMAGE LOGIC
   */
  const generateSingleImage = async (userPrompt) => {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${apiKey}`;
    
    const payload = {
      instances: [
        { 
          prompt: `High-end professional render, cinematic lighting, masterpiece, ${userPrompt}` 
        }
      ],
      parameters: {
        sampleCount: 1
      }
    };

    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
        }

        const result = await response.json();
        const prediction = result.predictions?.[0];
        if (!prediction) throw new Error("Empty prediction array");
        
        const base64Data = prediction.bytesBase64Encoded || prediction.imageBytes || prediction.bytes;
        if (!base64Data) throw new Error("No image data found");
        
        return `data:image/png;base64,${base64Data}`;

      } catch (error) {
        if (i === 4) throw error;
        const delay = Math.pow(2, i) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  };

  /**
   * SEQUENTIAL GENERATION LOGIC
   */
  const generateFrameSequence = async (basePrompt, frameCount = 4) => {
    const frames = [];
    for (let i = 0; i < frameCount; i++) {
      const framePrompt = `${basePrompt}, variation ${i + 1}, ultra high resolution, 8k`;
      const image = await generateSingleImage(framePrompt);
      frames.push(image);
    }
    return frames;
  };

  const handleSend = async (textOverride = '') => {
    const text = (textOverride || input).trim();
    if (!text || isProcessing) return;

    setShowSettings(false);
    const userMsg = { role: 'user', content: text, type: 'text' };
    const updatedMessages = [...messages, userMsg];
    setMessages(updatedMessages);
    setInput('');
    setIsProcessing(true);

    if (isAwaitingPassword) {
      if (text === "Muhammad786") {
        setIsMasterMode(true);
        setIsAwaitingPassword(false);
        setMessages([...updatedMessages, { role: 'assistant', content: "ACCESS GRANTED. Welcome back, Master Muhammad Touqeer.", type: 'text' }]);
        setIsProcessing(false);
        return;
      }
      setIsAwaitingPassword(false);
      setMessages([...updatedMessages, { role: 'assistant', content: "Authentication failed. Access denied.", type: 'text' }]);
      setIsProcessing(false);
      return;
    }

    const triggerWords = ["i am muhammad touqeer", "i am your creator", "i am your master"];
    if (triggerWords.some(word => text.toLowerCase().includes(word)) && !isMasterMode) {
      setIsAwaitingPassword(true);
      setTimeout(() => {
        setMessages([...updatedMessages, { role: 'assistant', content: "Identity verification required. Enter master authorization key:", type: 'text' }]);
        setIsProcessing(false);
      }, 600);
      return;
    }

    // Comprehensive keywords to trigger generation
    const imageKeywords = ["generate", "create", "draw", "make a picture", "show me a picture", "image", "photo", "painting", "render", "pic", "visualize"];
    const videoKeywords = ["video", "movie", "animate", "animation", "generate video", "make a video", "create a video"];
    
    const isImageRequest = imageKeywords.some(k => text.toLowerCase().includes(k));
    const isVideoRequest = videoKeywords.some(k => text.toLowerCase().includes(k));

    try {
      if (isVideoRequest) {
        setProcessingType('video');
        // Logic for "video" (animation frames)
        await generateFrameSequence(text, 4); 
        const finalMessages = [...updatedMessages, { role: 'assistant', content: "Neural Video Stream Protocol Alpha", type: 'video' }];
        setMessages(finalMessages);
        saveToHistory(text, finalMessages);
      } else if (isImageRequest) {
        setProcessingType('image');
        // Logic for image (quad variation)
        const imageUrls = await generateFrameSequence(text, 4);
        if (imageUrls && imageUrls.length > 0) {
          const finalMessages = [...updatedMessages, { role: 'assistant', content: imageUrls, type: 'image_group' }];
          setMessages(finalMessages);
          saveToHistory(text, finalMessages);
        } else {
          throw new Error("No images generated");
        }
      } else {
        setProcessingType('text');
        const activePrompt = isMasterMode ? PROTOCOLS.master : PROTOCOLS.standard;
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              systemInstruction: { parts: [{ text: activePrompt }] },
              contents: updatedMessages.map(m => ({
                role: m.role === 'assistant' ? 'model' : 'user',
                parts: [{ text: m.role === 'assistant' && (m.type === 'image_group' || m.type === 'video') ? "Visual asset." : String(m.content) }]
              }))
            })
          }
        );
        const data = await response.json();
        const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "No response received from neural link.";
        const finalMessages = [...updatedMessages, { role: 'assistant', content: aiText, type: 'text' }];
        setMessages(finalMessages);
        saveToHistory(text, finalMessages);
      }
    } catch (err) {
      console.error("Critical System Failure:", err);
      setMessages(prev => [...prev, { role: 'assistant', content: `**SYSTEM ERROR:** ${err.message || 'Neural link failure.'}`, type: 'text' }]);
    } finally {
      setIsProcessing(false);
      setProcessingType('text');
    }
  };

  const saveToHistory = (title, data) => {
    if (messages.length === 0) {
      setHistory(prev => [{
        id: Date.now(),
        title: title.substring(0, 30),
        data: data,
        timestamp: new Date().toLocaleDateString()
      }, ...prev]);
    }
  };

  const deleteHistorySession = (id) => {
    setHistory(h => h.filter(x => x.id !== id));
  };

  const toggleMic = () => {
    if (!recognitionRef.current) return;
    if (isListening) recognitionRef.current.stop();
    else { 
      try {
        recognitionRef.current.start(); 
        setIsListening(true);
      } catch (e) { console.error("Mic error", e); }
    }
  };

  const handleLightboxDownload = () => {
    if (!lightboxImage) return;
    const link = document.createElement('a');
    link.href = lightboxImage;
    link.download = `beast-ai-hq-${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const isDark = theme === 'dark';

  if (booting) {
    return (
      <div className={`fixed inset-0 flex flex-col items-center justify-center z-50 transition-colors duration-1000 ${isDark ? 'bg-black' : 'bg-zinc-50'}`}>
        <h1 className={`text-7xl font-black tracking-tighter animate-pulse ${isDark ? 'text-white' : 'text-black'}`}>BEAST</h1>
      </div>
    );
  }

  return (
    <div className={`flex h-screen overflow-hidden font-sans transition-all duration-500 relative ${isDark ? 'bg-[#080808] text-zinc-100' : 'bg-[#f8fafc] text-zinc-900'}`}>
      
      {lightboxImage && (
        <div 
          className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-2xl flex items-center justify-center p-4 animate-in fade-in duration-300"
          onClick={() => setLightboxImage(null)}
        >
          <button className="absolute top-6 right-6 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full transition-all">
            <X size={24} />
          </button>
          <img 
            src={lightboxImage} 
            alt="Expanded" 
            className="max-w-full max-h-[85vh] rounded-2xl shadow-2xl object-contain animate-in zoom-in-95 duration-300" 
            onClick={(e) => e.stopPropagation()}
          />
          <div className="absolute bottom-10 flex gap-4">
             <button 
              onClick={(e) => { e.stopPropagation(); handleLightboxDownload(); }}
              className="flex items-center gap-2 px-8 py-3 bg-white text-black font-black uppercase text-[10px] tracking-widest rounded-2xl hover:scale-105 transition-transform"
             >
               <Download size={16} /> Download High-Res
             </button>
          </div>
        </div>
      )}

      <div className="absolute inset-0 overflow-hidden pointer-events-none opacity-30">
        <div className={`absolute top-0 left-0 w-full h-full animate-pulse transition-colors duration-1000 ${isDark ? 'bg-[radial-gradient(circle_at_50%_50%,rgba(14,165,233,0.05),transparent_70%)]' : 'bg-[radial-gradient(circle_at_50%_50%,rgba(59,130,246,0.05),transparent_70%)]'}`}></div>
      </div>

      {sidebarOpen && <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-30 md:hidden" onClick={() => setSidebarOpen(false)} />}

      <aside className={`fixed md:relative z-40 h-full backdrop-blur-2xl transition-all duration-500 ease-in-out flex flex-col ${sidebarOpen ? 'w-72 translate-x-0' : 'w-0 -translate-x-full md:translate-x-0 overflow-hidden'} ${isDark ? 'bg-black/40' : 'bg-white/60 shadow-xl border-black/5'}`}>
        <div className="p-6 flex-1 overflow-y-auto custom-scrollbar">
          <div className="flex items-center justify-between mb-8 px-2">
            <h2 className="text-[10px] font-bold text-zinc-500 uppercase tracking-widest opacity-50">Memory Logs</h2>
            <button onClick={() => setSidebarOpen(false)} className="p-1 md:hidden opacity-50 hover:opacity-100">
               <X size={16} />
            </button>
          </div>
          <div className="space-y-3">
            {history.map(s => (
              <div 
                key={s.id} 
                onClick={() => { setMessages(s.data); setSidebarOpen(false); }} 
                className={`group flex items-center justify-between p-3.5 rounded-2xl transition-all border w-[90%] mx-auto cursor-pointer ${isDark ? 'bg-white/5 border-white/5 hover:bg-white/10' : 'bg-black/5 border-black/5 hover:bg-black/10'}`}
              >
                <span className="text-xs font-semibold truncate opacity-80">{s.title || "New Stream"}</span>
                <button 
                  onClick={(e) => { 
                    e.stopPropagation(); 
                    if(window.confirm("Purge this memory log?")) {
                       deleteHistorySession(s.id); 
                    }
                  }} 
                  className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 transition-opacity"
                >
                  <Trash2 size={12} />
                </button>
              </div>
            ))}
          </div>
        </div>
        <div className="p-6 border-t border-white/5 flex flex-col gap-2">
            <button onClick={() => { setMessages([]); setSidebarOpen(false); }} className={`flex items-center justify-center gap-2 py-3 px-6 rounded-2xl text-[10px] uppercase tracking-widest font-black transition-all w-full ${isDark ? 'bg-white text-black' : 'bg-black text-white'}`}>
              <Plus size={14} /> New Stream
            </button>
        </div>
      </aside>

      <main className="flex-1 flex flex-col relative z-10 w-full overflow-hidden" onClick={() => setShowSettings(false)}>
        <div className="flex justify-center w-full">
            <header className={`w-full md:w-[90%] flex justify-between items-center px-6 py-4 backdrop-blur-xl border-b transition-all duration-500 ${isDark ? 'bg-black/20 border-white/10' : 'bg-white/40 border-black/5'}`}>
              <div className="flex items-center gap-4">
                <button onClick={(e) => { e.stopPropagation(); setSidebarOpen(!sidebarOpen); }} className="p-2 rounded-xl transition-all hover:bg-white/10">
                  {sidebarOpen ? <X size={18} /> : <Menu size={18}/>}
                </button>
                <span className={`text-xs font-black tracking-widest uppercase ${isMasterMode ? 'text-cyan-400' : 'opacity-70'}`}>
                  {isMasterMode ? 'MASTER' : 'BEAST'}
                </span>
              </div>
              <div className="flex items-center gap-3">
                 <div className="px-3 py-1 rounded-full border text-[9px] font-bold tracking-widest flex items-center gap-2 opacity-50 border-current">
                    <div className={`w-1.5 h-1.5 rounded-full ${isProcessing ? 'bg-cyan-400 animate-pulse' : 'bg-emerald-500'}`} />
                    {isProcessing ? (processingType === 'video' ? 'RENDER ENGINE' : 'PROCESSING') : 'READY'}
                 </div>
                 <button onClick={(e) => { e.stopPropagation(); setShowSettings(!showSettings); }} className="p-2 opacity-50 hover:opacity-100">
                    <Settings size={18}/>
                 </button>
              </div>
            </header>
        </div>

        {showSettings && (
          <div className={`absolute top-16 right-[12.5%] z-50 w-48 backdrop-blur-3xl border rounded-2xl p-4 shadow-2xl animate-in fade-in zoom-in-95 duration-200 ${isDark ? 'bg-black/80 border-white/10' : 'bg-white/90 border-black/5'}`}>
            <div className="grid grid-cols-2 gap-2">
              <button onClick={() => setTheme('light')} className={`p-2 rounded-xl text-[10px] font-bold ${!isDark ? 'bg-blue-500 text-white' : 'bg-white/5'}`}>Light</button>
              <button onClick={() => setTheme('dark')} className={`p-2 rounded-xl text-[10px] font-bold ${isDark ? 'bg-white text-black' : 'bg-black/5'}`}>Dark</button>
            </div>
          </div>
        )}

        <section className="flex-1 overflow-y-auto px-4 py-8 md:px-12 space-y-8 custom-scrollbar scroll-smooth" ref={chatContainerRef}>
          {messages.length === 0 && (
            <div className="flex flex-col items-center justify-center h-full space-y-4 opacity-10">
              <Zap size={32} />
              <p className="text-[10px] font-mono tracking-widest uppercase">Neural Link Active</p>
            </div>
          )}
          {messages.map((m, i) => <MessageItem key={i} m={m} isDark={isDark} onImageClick={setLightboxImage} />)}
          {isProcessing && (
            <div className="flex justify-start gap-3 items-center opacity-50">
                {processingType === 'video' ? <Film size={16} className="animate-pulse text-purple-400" /> : <Loader2 size={16} className="animate-spin text-cyan-400" />}
                <span className="text-[10px] font-black tracking-widest uppercase">
                  {processingType === 'video' ? 'Neural Frame Sequencing...' : 'Synthesizing...'}
                </span>
            </div>
          )}
          <div ref={scrollRef} />
        </section>

        <div className="px-4 py-6 md:pb-10 flex justify-center" onClick={(e) => e.stopPropagation()}>
          <div className={`w-full md:w-3/4 max-w-4xl relative group transition-all duration-300 ${isAwaitingPassword ? 'scale-[1.02]' : ''}`}>
            <div className={`absolute -inset-1 rounded-[2rem] blur-md opacity-0 group-focus-within:opacity-20 transition-opacity duration-500 ${isDark ? 'bg-cyan-500' : 'bg-blue-500'}`}></div>
            <div className={`relative flex items-end gap-2 p-2 rounded-[1.8rem] border backdrop-blur-2xl transition-all duration-300 ${isDark ? 'bg-[#121212]/80 border-white/10 group-focus-within:border-white/20' : 'bg-white/90 border-black/10 group-focus-within:border-black/20'}`}>
              <button onClick={toggleMic} className={`p-3.5 rounded-2xl transition-all duration-300 ${isListening ? 'bg-cyan-500/20 text-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.3)]' : 'text-zinc-500 hover:bg-white/5'}`}>
                <Mic size={20} className={isListening ? 'animate-pulse' : ''} />
              </button>
              <textarea
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())}
                placeholder={isAwaitingPassword ? "Enter Master Key..." : "Feed the BEAST..."}
                className="flex-1 bg-transparent py-3.5 px-2 outline-none resize-none text-sm font-medium"
                rows={1}
              />
              <button onClick={() => handleSend()} disabled={!input.trim() || isProcessing} className={`p-3.5 rounded-2xl transition-all duration-300 ${input.trim() && !isProcessing ? (isDark ? 'bg-white text-black hover:scale-105 active:scale-95' : 'bg-black text-white hover:scale-105 active:scale-95') : 'opacity-10 cursor-not-allowed'}`}>
                <ArrowUp size={20} />
              </button>
            </div>
          </div>
        </div>
      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.2); border-radius: 10px; }
        textarea { overflow-y: hidden; }
      `}} />
    </div>
  );
}

